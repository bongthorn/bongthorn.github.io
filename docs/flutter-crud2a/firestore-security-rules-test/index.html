<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.61">
<title data-react-helmet="true">Step24 Firestore Security Rules Testing | Dev KH</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Step24 Firestore Security Rules Testing | Dev KH"><meta data-react-helmet="true" name="description" content="Goal of this step"><meta data-react-helmet="true" property="og:description" content="Goal of this step"><meta data-react-helmet="true" property="og:url" content="http://bongthorn.github.io/docs/flutter-crud2a/firestore-security-rules-test"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="http://bongthorn.github.io/docs/flutter-crud2a/firestore-security-rules-test"><link rel="stylesheet" href="/styles.088aabc7.css">
<link rel="preload" href="/styles.7edd1f46.js" as="script">
<link rel="preload" href="/runtime~main.6f168c28.js" as="script">
<link rel="preload" href="/main.6b3cd889.js" as="script">
<link rel="preload" href="/1.315f9378.js" as="script">
<link rel="preload" href="/2.7ea80aa8.js" as="script">
<link rel="preload" href="/155.e889abe4.js" as="script">
<link rel="preload" href="/156.907dde03.js" as="script">
<link rel="preload" href="/20ac7829.55bab08c.js" as="script">
<link rel="preload" href="/17896441.82591aaf.js" as="script">
<link rel="preload" href="/ad3da27e.fbceb807.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Dev Kh</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Document</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="My Site Logo"><strong class="navbar__title">Dev Kh</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Document</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/introduction">Introduction</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/install-flutter-sdk">Step1 Install Flutter Sdk</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/setup-vscode-editor">Step2 Setup VS Code Editor</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/create-flutter-app">Step3 Create and Run flutter App</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/write-initial-counter-app-from-scratch">Step4 Write initial counter app from scratch</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Step5 Folder Structure</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/prepare-files">Step5-1 Prepare files</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/note-about-import">Step5-2 Note about import</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Step6 Add Drawer and Routing</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/add-drawer">Step6-1 Add Drawer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/add-routing">Step6-2 Add Routing</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/setup-firebase">Step7 Setup Firebase</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Step8 Edit Register Page</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/edit-register-page/overview">Section Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/edit-register-page/build-a-form-with-validation">Build a form with validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/edit-register-page/styling-text-form-field">Style TextFormField</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/edit-register-page/fix-render-flex-error">Fix RenderFlex Error</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/edit-register-page/retrieve-value-from-text-form-field">Retrieve value from a text field</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/edit-register-page/improve-validation">Improve validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-crud2a/edit-register-page/add-firebase-auth">Add Firebase auth</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/login-page">Step9 Login Page</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/change-content-by-user-state">Step10 Change the content by user&#x27;s login state</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/provider-basics">Step11 Provider Basics</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/multi-provider">Step12 MultiProvider</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/change-notifier-provider">Step13 ChangeNotifierProvider</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/stream-provider">Step14 StreamProvider</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/recap-the-flow-of-state-management">Step15 Recap the flow of state management</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/create-user-in-firestore">Step16 Create User in Firestore</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/create-post">Step17 Create Post</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/list-posts">Step18 List Posts</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/show-post-page">Step19 Show Post Page</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/my-posts-page">Step20 My Posts Page</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/delete-post">Step21 Delete Post</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/edit-post-page">Step22 Edit Post Page</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/flutter-crud2a/firestore-security-rules">Step23 Firestore security rules</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/docs/flutter-crud2a/firestore-security-rules-test">Step24 Firestore Security Rules Testing</a></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Step24 Firestore Security Rules Testing</h1></header><div class="markdown"><h2 id="goal-of-this-step">Goal of this step</h2><ul><li>Learn how to write test for Firestore Security Rules</li></ul><h2 id="refs">Refs</h2><ul><li><a href="https://firebase.google.com/docs/firestore/security/test-rules-emulator">https://firebase.google.com/docs/firestore/security/test-rules-emulator</a></li><li><a href="https://medium.com/@adityadroid/60-days-of-flutter-building-a-messenger-day-55-56-deploying-firestore-security-rules-using-d8d78fd1eeea">https://medium.com/@adityadroid/60-days-of-flutter-building-a-messenger-day-55-56-deploying-firestore-security-rules-using-d8d78fd1eeea</a></li></ul><h2 id="setup">Setup</h2><h3 id="install-java">Install java</h3><p>If you haven&#x27;t installed java...</p><ul><li><a href="https://chocolatey.org/packages/openjdk#individual">https://chocolatey.org/packages/openjdk#individual</a></li><li><a href="https://firebase.google.com/docs/rules/emulator-setup">https://firebase.google.com/docs/rules/emulator-setup</a></li></ul><p>*You may need to restart your pc after install!</p><h3 id="install-firebase-cli">Install firebase cli</h3><p><a href="https://firebase.google.com/docs/cli/">https://firebase.google.com/docs/cli/</a></p><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;">npm install -g firebase-tools
</code></pre><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;">firebase login
</code></pre><p>Check it works correctly</p><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;">firebase projects:list
</code></pre><h3 id="make-server-folder">Make <code>server</code> folder</h3><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;">mkdir server
cd server
firebase init
</code></pre><h2 id="imitate-quickstart">Imitate Quickstart</h2><p><a href="https://firebase.google.com/docs/firestore/security/test-rules-emulator#quickstart">https://firebase.google.com/docs/firestore/security/test-rules-emulator#quickstart</a></p><h3 id="make-packagejson">Make <code>package.json</code></h3><pre><code class="language-json" metastring="title=&quot;server/package.json&quot;" title="&quot;server/package.json&quot;">{
  &quot;name&quot;: &quot;cloud-firestore-emulator-javascript-quickstart&quot;,
  &quot;version&quot;: &quot;1.0.2&quot;,
  &quot;description&quot;: &quot;Cloud Firestore emulator testing&quot;,
  &quot;scripts&quot;: {
    &quot;format&quot;: &quot;prettier --write **/*.js&quot;,
    &quot;test&quot;: &quot;mocha --timeout=10000&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;@firebase/testing&quot;: &quot;^0.16.11&quot;,
    &quot;mocha&quot;: &quot;5.2.0&quot;,
    &quot;prettier&quot;: &quot;1.15.2&quot;
  }
}
</code></pre><h3 id="npm-install">npm install</h3><p>run <code>npm install</code> in sever directory.</p><h3 id="make-testtestjs">Make <code>test/test.js</code></h3><pre><code class="language-js" metastring="{10} title=&quot;test/test.js&quot;" title="&quot;test/test.js&quot;">const firebase = require(&quot;@firebase/testing&quot;);
const fs = require(&quot;fs&quot;);

/*
 * ============
 *    Setup
 * ============
 */
const projectId = &quot;firestore-emulator-example&quot;;
const port = 8080;
const coverageUrl = `http://localhost:${port}/emulator/v1/projects/${projectId}:ruleCoverage.html`;

const rules = fs.readFileSync(&quot;firestore.rules&quot;, &quot;utf8&quot;);

/**
 * Creates a new app with authentication data matching the input.
 *
 * @param {object} auth the object to use for authentication (typically {uid: some-uid})
 * @return {object} the app.
 */
function authedApp(auth) {
  return firebase.initializeTestApp({ projectId, auth }).firestore();
}

/*
 * ============
 *  Test Cases
 * ============
 */
beforeEach(async () =&gt; {
  // Clear the database between tests
  await firebase.clearFirestoreData({ projectId });
});

before(async () =&gt; {
  await firebase.loadFirestoreRules({ projectId, rules });
});

after(async () =&gt; {
  await Promise.all(firebase.apps().map(app =&gt; app.delete()));
  console.log(`View rule coverage information at ${coverageUrl}\n`);
});

describe(&quot;My app&quot;, () =&gt; {
  it(&quot;require users to log in before creating a profile&quot;, async () =&gt; {
    const db = authedApp(null);
    const profile = db.collection(&quot;users&quot;).doc(&quot;alice&quot;);
    await firebase.assertFails(profile.set({ birthday: &quot;January 1&quot; }));
  });

  it(&quot;should enforce the createdAt date in user profiles&quot;, async () =&gt; {
    const db = authedApp({ uid: &quot;alice&quot; });
    const profile = db.collection(&quot;users&quot;).doc(&quot;alice&quot;);
    await firebase.assertFails(profile.set({ birthday: &quot;January 1&quot; }));
    await firebase.assertSucceeds(
      profile.set({
        birthday: &quot;January 1&quot;,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      })
    );
  });

  it(&quot;should only let users create their own profile&quot;, async () =&gt; {
    const db = authedApp({ uid: &quot;alice&quot; });
    await firebase.assertSucceeds(
      db
        .collection(&quot;users&quot;)
        .doc(&quot;alice&quot;)
        .set({
          birthday: &quot;January 1&quot;,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
    );
    await firebase.assertFails(
      db
        .collection(&quot;users&quot;)
        .doc(&quot;bob&quot;)
        .set({
          birthday: &quot;January 1&quot;,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
    );
  });

  it(&quot;should let anyone read any profile&quot;, async () =&gt; {
    const db = authedApp(null);
    const profile = db.collection(&quot;users&quot;).doc(&quot;alice&quot;);
    await firebase.assertSucceeds(profile.get());
  });

  it(&quot;should let anyone create a room&quot;, async () =&gt; {
    const db = authedApp({ uid: &quot;alice&quot; });
    const room = db.collection(&quot;rooms&quot;).doc(&quot;firebase&quot;);
    await firebase.assertSucceeds(
      room.set({
        owner: &quot;alice&quot;,
        topic: &quot;All Things Firebase&quot;
      })
    );
  });

  it(&quot;should force people to name themselves as room owner when creating a room&quot;, async () =&gt; {
    const db = authedApp({ uid: &quot;alice&quot; });
    const room = db.collection(&quot;rooms&quot;).doc(&quot;firebase&quot;);
    await firebase.assertFails(
      room.set({
        owner: &quot;scott&quot;,
        topic: &quot;Firebase Rocks!&quot;
      })
    );
  });

  it(&quot;should not let one user steal a room from another user&quot;, async () =&gt; {
    const alice = authedApp({ uid: &quot;alice&quot; });
    const bob = authedApp({ uid: &quot;bob&quot; });

    await firebase.assertSucceeds(
      bob
        .collection(&quot;rooms&quot;)
        .doc(&quot;snow&quot;)
        .set({
          owner: &quot;bob&quot;,
          topic: &quot;All Things Snowboarding&quot;
        })
    );

    await firebase.assertFails(
      alice
        .collection(&quot;rooms&quot;)
        .doc(&quot;snow&quot;)
        .set({
          owner: &quot;alice&quot;,
          topic: &quot;skiing &gt; snowboarding&quot;
        })
    );
  });
});
</code></pre><h3 id="copy-quickstart-rules">Copy quickstart rules.</h3><pre><code class="language-js" metastring="title=&quot;firestore.rules&quot;" title="&quot;firestore.rules&quot;">rules_version = &#x27;2&#x27;;

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read;
      allow create: if request.auth.uid == userId &amp;&amp; request.resource.data.createdAt == request.time;
    }
    match /rooms/{roomId} {
      allow read;
      // If you create a room, you must set yourself as the owner.
      allow create: if request.resource.data.owner == request.auth.uid;
      // Only the room owner is allowed to modify it.
      allow update: if resource.data.owner == request.auth.uid;
    }
  }
}
</code></pre><h3 id="run-test">Run Test</h3><p>Let&#x27;s run example test.</p><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;">firebase emulators:exec --only firestore &#x27;npm test&#x27;
</code></pre><h2 id="test-case-for-our-flutter-app">Test case for our Flutter app</h2><p>So, let&#x27;s write test for out security rules by imitating quickstart example.</p><pre><code class="language-js" metastring="title=&quot;test/test.js&quot;" title="&quot;test/test.js&quot;">...
describe(&quot;My app&quot;, () =&gt; {
  it(&quot;require users to log in before creating a user&quot;, async () =&gt; {
    const db = authedApp(null);
    const user = db.collection(&quot;users&quot;).doc(&quot;alice&quot;);
    await firebase.assertFails(user.set({ name: &quot;Alice&quot; }));
  });

  it(&quot;should let anyone read any published posts&quot;, async () =&gt; {  
    const db = authedApp(null);
    const queryPublished = db.collectionGroup(&#x27;posts&#x27;).where(&quot;published&quot;, &quot;==&quot;, true).get();
    const queryDrafts = db.collectionGroup(&#x27;posts&#x27;).where(&quot;published&quot;, &quot;==&quot;, false).get();
    await firebase.assertSucceeds(queryPublished);
    await firebase.assertFails(queryDrafts);
  });

  it(&quot;should only let users to query their own post&quot;, async () =&gt; {
    const db = authedApp({ uid: &quot;alice&quot; });
    await firebase.assertSucceeds(
      db
        .collection(&quot;users&quot;)
        .doc(&quot;alice&quot;)
        .collection(&quot;posts&quot;)
        .get()
    );
    await firebase.assertFails(
      db
        .collection(&quot;users&quot;)
        .doc(&quot;bob&quot;)
        .collection(&quot;posts&quot;)
        .get()
    );
  });

  it(&quot;should not allow to read other&#x27;s draft post&quot;, async () =&gt; {
    const alice = authedApp({ uid: &quot;alice&quot; });
    const bob = authedApp({ uid: &quot;bob&quot; });

    // Make alice&#x27;s draft post
    const aliceDraftPost = alice.collection(&quot;users&quot;).doc(&quot;alice&quot;).collection(&quot;posts&quot;).doc(&quot;alice-post1&quot;);
    await aliceDraftPost.set({title: &quot;title&quot;, published: false});

    // Make alice&#x27;s published post
    const alicePublicPost = alice.collection(&quot;users&quot;).doc(&quot;alice&quot;).collection(&quot;posts&quot;).doc(&quot;alice-post2&quot;);
    await alicePublicPost.set({title: &quot;title&quot;, published: true});

    // Bob access alice&#x27;s draft post
    const bobQuery1 = bob.collection(&quot;users&quot;).doc(&quot;alice&quot;).collection(&quot;posts&quot;).doc(&quot;alice-post1&quot;).get();

    // Bob access alice&#x27;s published post
    const bobQuery2 = bob.collection(&quot;users&quot;).doc(&quot;alice&quot;).collection(&quot;posts&quot;).doc(&quot;alice-post2&quot;).get();

    // Alice access alice&#x27;s draft post
    const aliceQuery = aliceDraftPost.get();

    await firebase.assertFails(bobQuery1);
    await firebase.assertSucceeds(bobQuery2);
    await firebase.assertSucceeds(aliceQuery);
  });


  it(&quot;require users to log in before creating a post&quot;, async () =&gt; {
    const db = authedApp(null);
    const query = db.collection(&quot;users&quot;).doc(&quot;alice&quot;)
                    .collection(&quot;posts&quot;).doc()
                    .set({
                      title: &quot;alice&quot;,
                      content: &quot;All Things Firebase&quot;
                    })
    await firebase.assertFails(query);
  });

  it(&quot;requires title field to create a post&quot;, async () =&gt; {
    const db = authedApp({ uid: &quot;alice&quot; });
    const postDocRef = db.collection(&quot;users&quot;).doc(&quot;alice&quot;).collection(&quot;posts&quot;).doc()
                  
    await firebase.assertFails(postDocRef.set({title: &quot;&quot;}));
    await firebase.assertSucceeds(postDocRef.set({title: &quot;title 1&quot;}));
  });


  it(&quot;should not allow to update other&#x27;s post&quot;, async () =&gt; {
    const alice = authedApp({ uid: &quot;alice&quot; });
    const bob = authedApp({ uid: &quot;bob&quot; });

    // Make bob&#x27;s post
    await bob.collection(&quot;users&quot;).doc(&quot;bob&quot;)
      .collection(&quot;posts&quot;).doc(&quot;bobPost1&quot;)
      .set({title: &quot;hogehoge&quot;});

    // alice query to update bob&#x27;s post
    aliceQuery = alice.collection(&quot;users&quot;).doc(&quot;bob&quot;)
                  .collection(&quot;posts&quot;).doc(&quot;bobPost1&quot;)
                  .update({title: &quot;hoge&quot;});
                  
    await firebase.assertFails(aliceQuery);
  });

  it(&quot;requires title field to update a post&quot;, async () =&gt; {
    const db = authedApp({ uid: &quot;alice&quot; });
    const postDocRef = db.collection(&quot;users&quot;).doc(&quot;alice&quot;).collection(&quot;posts&quot;).doc(&quot;post1&quot;);
    await postDocRef.set({title: &quot;hogehgoe&quot;});
                  
    await firebase.assertFails(postDocRef.update({title: &quot;&quot;}));
    await firebase.assertSucceeds(postDocRef.update({title: &quot;title 1&quot;}));
  });

  it(&quot;should not allow to delete other&#x27;s post&quot;, async () =&gt; {
    const alice = authedApp({ uid: &quot;alice&quot; });

    // alice query to update bob&#x27;s post
    aliceQuery = alice.collection(&quot;users&quot;).doc(&quot;bob&quot;)
                  .collection(&quot;posts&quot;).doc(&quot;bobPost1&quot;)
                  .delete();
                  
    await firebase.assertFails(aliceQuery);
  });
});
</code></pre><h2 id="check-test-reports">Check test reports</h2><p><a href="https://firebase.google.com/docs/rules/emulator-reports">https://firebase.google.com/docs/rules/emulator-reports</a></p><h3 id="start-emulator">Start emulator</h3><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;">firebase emulators:start --only firestore
</code></pre><p>Then, in another terminal tab</p><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;">npm run test
</code></pre><p>And visit generated url</p><h3 id="test-coverage">Test Coverage</h3><p><a href="https://firebase.google.com/docs/rules/emulator-reports">https://firebase.google.com/docs/rules/emulator-reports</a></p><p>If test is not applied to the rules, it shows message like this.
<img src="https://storage.googleapis.com/coderhackers-assets/flutter_firebase_firestore_crud2a/Screen%20Shot%202020-02-27%20at%205.31.13.png" alt="ss-of-coverage"></p><h2 id="deploy-rules">Deploy Rules</h2><pre><code class="language-bash" metastring="title=&quot;terminal&quot;" title="&quot;terminal&quot;"># inside server dir
firebase deploy --only firestore:rules
</code></pre><h2 id="seed-data">Seed data</h2><p>This is just a memo links.</p><p><a href="https://github.com/firebase/firebase-tools/issues/1167#issuecomment-545641337">https://github.com/firebase/firebase-tools/issues/1167#issuecomment-545641337</a>
<a href="https://stackoverflow.com/questions/56268092/how-to-setup-test-data-when-testing-firestore-rules-with-emulator">https://stackoverflow.com/questions/56268092/how-to-setup-test-data-when-testing-firestore-rules-with-emulator</a>
<a href="https://github.com/sgr-ksmt/firestore-emulator-rules-test/blob/master/test/test.ts">https://github.com/sgr-ksmt/firestore-emulator-rules-test/blob/master/test/test.ts</a>
<a href="https://techlife.cookpad.com/entry/2018/11/05/143000">https://techlife.cookpad.com/entry/2018/11/05/143000</a></p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/facebook/docusaurus/edit/master/website/docs/flutter-crud2a/firestore-security-rules-test.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/flutter-crud2a/firestore-security-rules"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Step23 Firestore security rules</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3klQ"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#goal-of-this-step" class="table-of-contents__link">Goal of this step</a></li><li><a href="#refs" class="table-of-contents__link">Refs</a></li><li><a href="#setup" class="table-of-contents__link">Setup</a><ul><li><a href="#install-java" class="table-of-contents__link">Install java</a></li><li><a href="#install-firebase-cli" class="table-of-contents__link">Install firebase cli</a></li><li><a href="#make-server-folder" class="table-of-contents__link">Make <code>server</code> folder</a></li></ul></li><li><a href="#imitate-quickstart" class="table-of-contents__link">Imitate Quickstart</a><ul><li><a href="#make-packagejson" class="table-of-contents__link">Make <code>package.json</code></a></li><li><a href="#npm-install" class="table-of-contents__link">npm install</a></li><li><a href="#make-testtestjs" class="table-of-contents__link">Make <code>test/test.js</code></a></li><li><a href="#copy-quickstart-rules" class="table-of-contents__link">Copy quickstart rules.</a></li><li><a href="#run-test" class="table-of-contents__link">Run Test</a></li></ul></li><li><a href="#test-case-for-our-flutter-app" class="table-of-contents__link">Test case for our Flutter app</a></li><li><a href="#check-test-reports" class="table-of-contents__link">Check test reports</a><ul><li><a href="#start-emulator" class="table-of-contents__link">Start emulator</a></li><li><a href="#test-coverage" class="table-of-contents__link">Test Coverage</a></li></ul></li><li><a href="#deploy-rules" class="table-of-contents__link">Deploy Rules</a></li><li><a href="#seed-data" class="table-of-contents__link">Seed data</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow</a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2020 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.7edd1f46.js"></script>
<script src="/runtime~main.6f168c28.js"></script>
<script src="/main.6b3cd889.js"></script>
<script src="/1.315f9378.js"></script>
<script src="/2.7ea80aa8.js"></script>
<script src="/155.e889abe4.js"></script>
<script src="/156.907dde03.js"></script>
<script src="/20ac7829.55bab08c.js"></script>
<script src="/17896441.82591aaf.js"></script>
<script src="/ad3da27e.fbceb807.js"></script>
</body>
</html>